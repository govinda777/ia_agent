# ğŸ—ï¸ ARCHITECTURE.md â€” CRM Casal do TrÃ¡fego

> **VersÃ£o:** 1.0.0  
> **Ãšltima AtualizaÃ§Ã£o:** 2025-12-11  
> **Autor:** Arquitetura de Software

---

## ğŸ“‹ Ãndice

1. [VisÃ£o Geral](#1-visÃ£o-geral)
2. [Diagrama de Arquitetura](#2-diagrama-de-arquitetura)
3. [Camadas da AplicaÃ§Ã£o](#3-camadas-da-aplicaÃ§Ã£o)
4. [Fluxo de Dados](#4-fluxo-de-dados)
5. [ComunicaÃ§Ã£o Frontend â†” Backend](#5-comunicaÃ§Ã£o-frontend--backend)
6. [Engine do Agente IA](#6-engine-do-agente-ia)
7. [GestÃ£o de Estado das Conversas](#7-gestÃ£o-de-estado-das-conversas)
8. [IntegraÃ§Ãµes Externas](#8-integraÃ§Ãµes-externas)
9. [SeguranÃ§a e AutenticaÃ§Ã£o](#9-seguranÃ§a-e-autenticaÃ§Ã£o)
10. [DecisÃµes de Design](#10-decisÃµes-de-design)

---

## 1. VisÃ£o Geral

### 1.1 PropÃ³sito do Sistema

O **CRM Casal do TrÃ¡fego** Ã© uma plataforma de automaÃ§Ã£o de atendimento via WhatsApp, projetada para:

- **Automatizar conversas** com leads atravÃ©s de agentes de IA configurÃ¡veis
- **Centralizar conhecimento** em bases de dados que alimentam os agentes
- **Integrar calendÃ¡rio** para agendamento automÃ¡tico de reuniÃµes
- **Capturar leads** automaticamente em planilhas do Google
- **Monitorar mÃ©tricas** de atendimento em tempo real

### 1.2 Stack TecnolÃ³gica

| Camada | Tecnologia | VersÃ£o | Justificativa |
|--------|------------|--------|---------------|
| Framework | Next.js | 15.x | App Router, Server Components, Server Actions |
| Linguagem | TypeScript | 5.x | Type Safety, DX superior |
| AI Engine | Vercel AI SDK | 4.x | `generateText`, `tool calling` nativo |
| Database | Neon + Drizzle | Latest | Serverless Postgres, ORM type-safe |
| UI | Shadcn UI | Latest | Componentes acessÃ­veis, customizÃ¡veis |
| Styling | Tailwind CSS | 4.x | Design system consistente |
| Icons | Lucide React | Latest | Ãcones otimizados |

### 1.3 PrincÃ­pios Arquiteturais

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PRINCÃPIOS CORE                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. Separation of Concerns (SoC)                            â”‚
â”‚     â””â”€ Cada camada tem responsabilidade Ãºnica               â”‚
â”‚                                                             â”‚
â”‚  2. Server-First Architecture                               â”‚
â”‚     â””â”€ LÃ³gica de negÃ³cio SEMPRE no servidor                 â”‚
â”‚                                                             â”‚
â”‚  3. Type Safety End-to-End                                  â”‚
â”‚     â””â”€ TypeScript strict do DB atÃ© o Frontend               â”‚
â”‚                                                             â”‚
â”‚  4. Stateless Webhook Processing                            â”‚
â”‚     â””â”€ Cada requisiÃ§Ã£o Ã© independente, contexto vem do DB   â”‚
â”‚                                                             â”‚
â”‚  5. Fail-Safe AI Responses                                  â”‚
â”‚     â””â”€ Sempre ter fallback quando a IA nÃ£o conseguir        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Diagrama de Arquitetura

### 2.1 VisÃ£o Macro do Sistema

```
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚         EXTERNAL SERVICES           â”‚
                                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â” â”‚
                                    â”‚  â”‚ WhatsAppâ”‚  â”‚ Google  â”‚  â”‚OpenAIâ”‚ â”‚
                                    â”‚  â”‚  Meta   â”‚  â”‚Calendar â”‚  â”‚ API  â”‚ â”‚
                                    â”‚  â”‚   API   â”‚  â”‚+ Sheets â”‚  â”‚      â”‚ â”‚
                                    â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”€â”˜ â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”˜
                                            â”‚           â”‚          â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                        API LAYER (Next.js App Router)                 â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚                                                                       â”‚
                    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
                    â”‚   â”‚  /api/webhooks/whatsapp  â”‚    â”‚    /api/auth/[...next]   â”‚       â”‚
                    â”‚   â”‚  (Incoming Messages)     â”‚    â”‚    (Authentication)      â”‚       â”‚
                    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
                    â”‚                â”‚                                                      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                         SERVER LAYER                                  â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚                                                                       â”‚
                    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
                    â”‚   â”‚    /server      â”‚   â”‚    /server      â”‚   â”‚    /server      â”‚    â”‚
                    â”‚   â”‚    /actions     â”‚   â”‚    /services    â”‚   â”‚    /queries     â”‚    â”‚
                    â”‚   â”‚ (Mutations)     â”‚   â”‚ (Integrations)  â”‚   â”‚ (Data Fetch)    â”‚    â”‚
                    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
                    â”‚            â”‚                     â”‚                     â”‚             â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚                     â”‚                     â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                          DATA LAYER                                   â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚                                                                       â”‚
                    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
                    â”‚   â”‚                    Drizzle ORM + Neon                        â”‚    â”‚
                    â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
                    â”‚   â”‚  â”‚ agents  â”‚ â”‚knowledge_base â”‚ â”‚integrationsâ”‚ â”‚ threads  â”‚  â”‚    â”‚
                    â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
                    â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚    â”‚
                    â”‚   â”‚  â”‚ messages â”‚                                               â”‚    â”‚
                    â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚    â”‚
                    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
                    â”‚                                                                       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                         FRONTEND LAYER                                â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚                                                                       â”‚
                    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
                    â”‚   â”‚                    /app (App Router)                       â”‚      â”‚
                    â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚      â”‚
                    â”‚   â”‚  â”‚  /dashboard â”‚  â”‚  /agents    â”‚  â”‚  /knowledge     â”‚    â”‚      â”‚
                    â”‚   â”‚  â”‚  (Overview) â”‚  â”‚  (Builder)  â”‚  â”‚  (Base Editor)  â”‚    â”‚      â”‚
                    â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚      â”‚
                    â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚      â”‚
                    â”‚   â”‚  â”‚  /threads   â”‚  â”‚ /analytics  â”‚                         â”‚      â”‚
                    â”‚   â”‚  â”‚  (Inbox)    â”‚  â”‚ (Metrics)   â”‚                         â”‚      â”‚
                    â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚      â”‚
                    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
                    â”‚                                                                       â”‚
                    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
                    â”‚   â”‚                    /components                             â”‚      â”‚
                    â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚      â”‚
                    â”‚   â”‚  â”‚  /ui   â”‚  â”‚ /layout  â”‚  â”‚        /features           â”‚ â”‚      â”‚
                    â”‚   â”‚  â”‚ Shadcn â”‚  â”‚ Sidebar  â”‚  â”‚ agent-builder, chat-previewâ”‚ â”‚      â”‚
                    â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚      â”‚
                    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
                    â”‚                                                                       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. Camadas da AplicaÃ§Ã£o

### 3.1 Estrutura de DiretÃ³rios Detalhada

```
/src
â”œâ”€â”€ /app                              # Next.js App Router
â”‚   â”œâ”€â”€ /dashboard                    # PÃ¡gina Principal (Protegida)
â”‚   â”‚   â”œâ”€â”€ page.tsx                  # Overview com mÃ©tricas
â”‚   â”‚   â””â”€â”€ layout.tsx                # Layout com Sidebar
â”‚   â”‚
â”‚   â”œâ”€â”€ /dashboard/agents             # GestÃ£o de Agentes
â”‚   â”‚   â”œâ”€â”€ page.tsx                  # Lista de agentes
â”‚   â”‚   â””â”€â”€ /[id]
â”‚   â”‚       â””â”€â”€ page.tsx              # Editor do agente
â”‚   â”‚
â”‚   â”œâ”€â”€ /dashboard/knowledge          # Base de Conhecimento
â”‚   â”‚   â””â”€â”€ page.tsx                  # Editor de tÃ³picos
â”‚   â”‚
â”‚   â”œâ”€â”€ /dashboard/threads            # Inbox de Conversas
â”‚   â”‚   â”œâ”€â”€ page.tsx                  # Lista de threads
â”‚   â”‚   â””â”€â”€ /[id]
â”‚   â”‚       â””â”€â”€ page.tsx              # Visualizador de conversa
â”‚   â”‚
â”‚   â”œâ”€â”€ /dashboard/analytics          # MÃ©tricas
â”‚   â”‚   â””â”€â”€ page.tsx                  # GrÃ¡ficos e KPIs
â”‚   â”‚
â”‚   â”œâ”€â”€ /dashboard/integrations       # Configurar IntegraÃ§Ãµes
â”‚   â”‚   â””â”€â”€ page.tsx                  # OAuth Google, Meta
â”‚   â”‚
â”‚   â”œâ”€â”€ /api                          # API Routes
â”‚   â”‚   â”œâ”€â”€ /webhooks
â”‚   â”‚   â”‚   â””â”€â”€ /whatsapp
â”‚   â”‚   â”‚       â””â”€â”€ route.ts          # Handler principal
â”‚   â”‚   â””â”€â”€ /auth
â”‚   â”‚       â””â”€â”€ /[...nextauth]
â”‚   â”‚           â””â”€â”€ route.ts          # NextAuth handler
â”‚   â”‚
â”‚   â”œâ”€â”€ layout.tsx                    # Root Layout
â”‚   â”œâ”€â”€ page.tsx                      # Landing Page
â”‚   â””â”€â”€ globals.css                   # Tailwind imports
â”‚
â”œâ”€â”€ /components                       # Componentes React
â”‚   â”œâ”€â”€ /ui                           # Shadcn primitives
â”‚   â”‚   â”œâ”€â”€ button.tsx
â”‚   â”‚   â”œâ”€â”€ card.tsx
â”‚   â”‚   â”œâ”€â”€ input.tsx
â”‚   â”‚   â”œâ”€â”€ textarea.tsx
â”‚   â”‚   â”œâ”€â”€ select.tsx
â”‚   â”‚   â”œâ”€â”€ dialog.tsx
â”‚   â”‚   â”œâ”€â”€ dropdown-menu.tsx
â”‚   â”‚   â”œâ”€â”€ avatar.tsx
â”‚   â”‚   â”œâ”€â”€ badge.tsx
â”‚   â”‚   â”œâ”€â”€ skeleton.tsx
â”‚   â”‚   â””â”€â”€ toast.tsx
â”‚   â”‚
â”‚   â”œâ”€â”€ /layout                       # Layout Components
â”‚   â”‚   â”œâ”€â”€ sidebar.tsx               # NavegaÃ§Ã£o lateral
â”‚   â”‚   â”œâ”€â”€ header.tsx                # Header com user menu
â”‚   â”‚   â”œâ”€â”€ page-wrapper.tsx          # Container de pÃ¡gina
â”‚   â”‚   â””â”€â”€ mobile-nav.tsx            # Menu mobile
â”‚   â”‚
â”‚   â””â”€â”€ /features                     # Feature Components
â”‚       â”œâ”€â”€ /agent-builder
â”‚       â”‚   â”œâ”€â”€ agent-form.tsx        # FormulÃ¡rio principal
â”‚       â”‚   â”œâ”€â”€ prompt-editor.tsx     # Editor de System Prompt
â”‚       â”‚   â”œâ”€â”€ model-selector.tsx    # Seletor de modelo
â”‚       â”‚   â””â”€â”€ tool-configurator.tsx # Config de ferramentas
â”‚       â”‚
â”‚       â”œâ”€â”€ /chat-preview
â”‚       â”‚   â”œâ”€â”€ chat-container.tsx    # Container do chat
â”‚       â”‚   â”œâ”€â”€ message-bubble.tsx    # Bolha de mensagem
â”‚       â”‚   â””â”€â”€ chat-input.tsx        # Input de teste
â”‚       â”‚
â”‚       â”œâ”€â”€ /knowledge-base
â”‚       â”‚   â”œâ”€â”€ topic-list.tsx        # Lista de tÃ³picos
â”‚       â”‚   â”œâ”€â”€ topic-editor.tsx      # Editor de conteÃºdo
â”‚       â”‚   â””â”€â”€ import-dialog.tsx     # Importar documentos
â”‚       â”‚
â”‚       â”œâ”€â”€ /threads
â”‚       â”‚   â”œâ”€â”€ thread-list.tsx       # Lista de conversas
â”‚       â”‚   â”œâ”€â”€ thread-item.tsx       # Item individual
â”‚       â”‚   â””â”€â”€ thread-viewer.tsx     # Visualizador completo
â”‚       â”‚
â”‚       â””â”€â”€ /analytics
â”‚           â”œâ”€â”€ stats-cards.tsx       # Cards de mÃ©tricas
â”‚           â”œâ”€â”€ usage-chart.tsx       # GrÃ¡fico de uso
â”‚           â””â”€â”€ response-time.tsx     # Tempo de resposta
â”‚
â”œâ”€â”€ /lib                              # ConfiguraÃ§Ãµes Core
â”‚   â”œâ”€â”€ /ai
â”‚   â”‚   â”œâ”€â”€ config.ts                 # Config do Vercel AI SDK
â”‚   â”‚   â”œâ”€â”€ tools.ts                  # DefiniÃ§Ã£o das ferramentas
â”‚   â”‚   â””â”€â”€ prompts.ts                # Templates de prompts
â”‚   â”‚
â”‚   â”œâ”€â”€ /db
â”‚   â”‚   â”œâ”€â”€ index.ts                  # Drizzle client export
â”‚   â”‚   â””â”€â”€ config.ts                 # Neon connection config
â”‚   â”‚
â”‚   â”œâ”€â”€ utils.ts                      # Helpers globais
â”‚   â”œâ”€â”€ constants.ts                  # Constantes da aplicaÃ§Ã£o
â”‚   â””â”€â”€ types.ts                      # Types compartilhados
â”‚
â”œâ”€â”€ /server                           # Server-Side Logic
â”‚   â”œâ”€â”€ /actions                      # Server Actions
â”‚   â”‚   â”œâ”€â”€ agent.actions.ts          # CRUD de agentes
â”‚   â”‚   â”œâ”€â”€ knowledge.actions.ts      # CRUD de knowledge base
â”‚   â”‚   â”œâ”€â”€ thread.actions.ts         # GestÃ£o de threads
â”‚   â”‚   â””â”€â”€ integration.actions.ts    # Config de integraÃ§Ãµes
â”‚   â”‚
â”‚   â”œâ”€â”€ /services                     # External Services
â”‚   â”‚   â”œâ”€â”€ openai.service.ts         # OpenAI API wrapper
â”‚   â”‚   â”œâ”€â”€ google-calendar.service.ts# Google Calendar API
â”‚   â”‚   â”œâ”€â”€ google-sheets.service.ts  # Google Sheets API
â”‚   â”‚   â””â”€â”€ meta-whatsapp.service.ts  # Meta WhatsApp API
â”‚   â”‚
â”‚   â””â”€â”€ /queries                      # Database Queries
â”‚       â”œâ”€â”€ agent.queries.ts          # Queries de agentes
â”‚       â”œâ”€â”€ knowledge.queries.ts      # Queries de knowledge
â”‚       â”œâ”€â”€ thread.queries.ts         # Queries de threads
â”‚       â””â”€â”€ message.queries.ts        # Queries de mensagens
â”‚
â”œâ”€â”€ /db                               # Database Schema
â”‚   â””â”€â”€ schema.ts                     # Drizzle Schema completo
â”‚
â””â”€â”€ /docs                             # DocumentaÃ§Ã£o
    â”œâ”€â”€ ARCHITECTURE.md               # Este documento
    â”œâ”€â”€ API.md                        # DocumentaÃ§Ã£o de APIs
    â””â”€â”€ DEPLOYMENT.md                 # Guia de deploy
```

### 3.2 Responsabilidades por Camada

| Camada | DiretÃ³rio | Responsabilidade | Pode Acessar |
|--------|-----------|------------------|--------------|
| **Presentation** | `/app`, `/components` | RenderizaÃ§Ã£o, UX, InteraÃ§Ã£o | Server Actions |
| **Actions** | `/server/actions` | MutaÃ§Ãµes, ValidaÃ§Ã£o, Cache Invalidation | Services, Queries |
| **Services** | `/server/services` | ComunicaÃ§Ã£o com APIs externas | - |
| **Queries** | `/server/queries` | Leitura do banco de dados | Drizzle Client |
| **Data** | `/db` | DefiniÃ§Ã£o do schema | - |

---

## 4. Fluxo de Dados

### 4.1 Fluxo de Leitura (Frontend â†’ Backend â†’ DB)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          FLUXO DE LEITURA (READ)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   React       â”‚     â”‚   Server           â”‚     â”‚   Drizzle           â”‚
  â”‚   Component   â”‚â”€â”€â”€â”€â–¶â”‚   Component        â”‚â”€â”€â”€â”€â–¶â”‚   Query             â”‚
  â”‚   (Client)    â”‚     â”‚   (RSC)            â”‚     â”‚   /server/queries   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                               â”‚
                                                               â–¼
                                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                    â”‚   Neon Postgres     â”‚
                                                    â”‚   (Data)            â”‚
                                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

EXEMPLO CONCRETO:

  // 1. Page.tsx (Server Component) chama query diretamente
  // /app/dashboard/agents/page.tsx
  
  import { getAgents } from '@/server/queries/agent.queries';
  
  export default async function AgentsPage() {
    const agents = await getAgents(); // â† Query direto no server
    
    return <AgentList agents={agents} />;
  }
  
  // 2. Query busca no banco
  // /server/queries/agent.queries.ts
  
  export async function getAgents() {
    return await db.select().from(agents).orderBy(desc(agents.createdAt));
  }
```

### 4.2 Fluxo de Escrita (Frontend â†’ Server Action â†’ DB)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          FLUXO DE ESCRITA (WRITE)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   Form        â”‚     â”‚   Server           â”‚     â”‚   Drizzle           â”‚
  â”‚   Component   â”‚â”€â”€â”€â”€â–¶â”‚   Action           â”‚â”€â”€â”€â”€â–¶â”‚   Mutation          â”‚
  â”‚   (Client)    â”‚     â”‚   /server/actions  â”‚     â”‚   (insert/update)   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                             â”‚
         â”‚                       â”‚                             â–¼
         â”‚                       â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                       â”‚                  â”‚   Neon Postgres     â”‚
         â”‚                       â”‚                  â”‚   (Data)            â”‚
         â”‚                       â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
         â”‚                       â–¼
         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚              â”‚   revalidatePath   â”‚
         â”‚              â”‚   (Cache Bust)     â”‚
         â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
         â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              UI Atualizada


EXEMPLO CONCRETO:

  // 1. Client Component com formulÃ¡rio
  // /components/features/agent-builder/agent-form.tsx
  
  'use client';
  
  import { createAgent } from '@/server/actions/agent.actions';
  import { useFormState } from 'react-dom';
  
  export function AgentForm() {
    const [state, formAction] = useFormState(createAgent, null);
    
    return (
      <form action={formAction}>
        <input name="name" />
        <textarea name="systemPrompt" />
        <button type="submit">Criar Agente</button>
      </form>
    );
  }
  
  // 2. Server Action processa
  // /server/actions/agent.actions.ts
  
  'use server';
  
  import { db } from '@/lib/db';
  import { agents } from '@/db/schema';
  import { revalidatePath } from 'next/cache';
  
  export async function createAgent(prevState: any, formData: FormData) {
    const data = {
      name: formData.get('name') as string,
      systemPrompt: formData.get('systemPrompt') as string,
    };
    
    // ValidaÃ§Ã£o com Zod
    const validated = agentSchema.parse(data);
    
    // InserÃ§Ã£o no banco
    const [newAgent] = await db.insert(agents).values(validated).returning();
    
    // Invalida cache
    revalidatePath('/dashboard/agents');
    
    return { success: true, agent: newAgent };
  }
```

---

## 5. ComunicaÃ§Ã£o Frontend â†” Backend

### 5.1 PadrÃµes de ComunicaÃ§Ã£o

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PADRÃ•ES DE COMUNICAÃ‡ÃƒO                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                    SERVER COMPONENTS (RSC)                           â”‚  â”‚
â”‚   â”‚                                                                      â”‚  â”‚
â”‚   â”‚   USE PARA: Leitura de dados, SEO, carregamento inicial             â”‚  â”‚
â”‚   â”‚                                                                      â”‚  â”‚
â”‚   â”‚   â€¢ Renderizam no servidor                                          â”‚  â”‚
â”‚   â”‚   â€¢ Podem acessar DB diretamente via /server/queries                â”‚  â”‚
â”‚   â”‚   â€¢ NÃ£o usam hooks (useState, useEffect)                            â”‚  â”‚
â”‚   â”‚   â€¢ Passam dados para Client Components via props                   â”‚  â”‚
â”‚   â”‚                                                                      â”‚  â”‚
â”‚   â”‚   EXEMPLO:                                                          â”‚  â”‚
â”‚   â”‚   async function DashboardPage() {                                  â”‚  â”‚
â”‚   â”‚     const stats = await getStats(); // Query direto                 â”‚  â”‚
â”‚   â”‚     return <StatsCards data={stats} />;                             â”‚  â”‚
â”‚   â”‚   }                                                                 â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                    CLIENT COMPONENTS                                 â”‚  â”‚
â”‚   â”‚                                                                      â”‚  â”‚
â”‚   â”‚   USE PARA: Interatividade, formulÃ¡rios, estado local               â”‚  â”‚
â”‚   â”‚                                                                      â”‚  â”‚
â”‚   â”‚   â€¢ Marcados com 'use client'                                       â”‚  â”‚
â”‚   â”‚   â€¢ Podem usar hooks React                                          â”‚  â”‚
â”‚   â”‚   â€¢ Chamam Server Actions para mutaÃ§Ãµes                             â”‚  â”‚
â”‚   â”‚   â€¢ NÃƒO acessam DB diretamente                                      â”‚  â”‚
â”‚   â”‚                                                                      â”‚  â”‚
â”‚   â”‚   EXEMPLO:                                                          â”‚  â”‚
â”‚   â”‚   'use client';                                                     â”‚  â”‚
â”‚   â”‚   function AgentToggle({ agentId }) {                               â”‚  â”‚
â”‚   â”‚     const [pending, startTransition] = useTransition();             â”‚  â”‚
â”‚   â”‚     return (                                                        â”‚  â”‚
â”‚   â”‚       <Switch                                                       â”‚  â”‚
â”‚   â”‚         onCheckedChange={() => {                                    â”‚  â”‚
â”‚   â”‚           startTransition(() => toggleAgent(agentId));              â”‚  â”‚
â”‚   â”‚         }}                                                          â”‚  â”‚
â”‚   â”‚       />                                                            â”‚  â”‚
â”‚   â”‚     );                                                              â”‚  â”‚
â”‚   â”‚   }                                                                 â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                    SERVER ACTIONS                                    â”‚  â”‚
â”‚   â”‚                                                                      â”‚  â”‚
â”‚   â”‚   USE PARA: MutaÃ§Ãµes de dados, validaÃ§Ã£o, side effects              â”‚  â”‚
â”‚   â”‚                                                                      â”‚  â”‚
â”‚   â”‚   â€¢ Marcados com 'use server'                                       â”‚  â”‚
â”‚   â”‚   â€¢ Executam no servidor, chamados do cliente                       â”‚  â”‚
â”‚   â”‚   â€¢ ValidaÃ§Ã£o com Zod                                               â”‚  â”‚
â”‚   â”‚   â€¢ Chamam revalidatePath/revalidateTag apÃ³s mudanÃ§as               â”‚  â”‚
â”‚   â”‚                                                                      â”‚  â”‚
â”‚   â”‚   EXEMPLO:                                                          â”‚  â”‚
â”‚   â”‚   'use server';                                                     â”‚  â”‚
â”‚   â”‚   export async function deleteAgent(id: string) {                   â”‚  â”‚
â”‚   â”‚     await db.delete(agents).where(eq(agents.id, id));               â”‚  â”‚
â”‚   â”‚     revalidatePath('/dashboard/agents');                            â”‚  â”‚
â”‚   â”‚   }                                                                 â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 Mapeamento de Componentes para Actions

| Componente | Server Action | DescriÃ§Ã£o |
|------------|---------------|-----------|
| `AgentForm` | `createAgent`, `updateAgent` | CRUD de agentes |
| `PromptEditor` | `updateSystemPrompt` | EdiÃ§Ã£o de prompts |
| `TopicEditor` | `createTopic`, `updateTopic`, `deleteTopic` | GestÃ£o de knowledge |
| `IntegrationCard` | `connectIntegration`, `disconnectIntegration` | OAuth |
| `ThreadViewer` | `archiveThread`, `exportThread` | GestÃ£o de conversas |
| `AgentToggle` | `toggleAgentStatus` | Ativar/desativar agente |

---

## 6. Engine do Agente IA

### 6.1 Fluxo Completo do Webhook

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     FLUXO DO WEBHOOK WHATSAPP                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  WhatsApp    â”‚
    â”‚  User        â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ 1. Envia mensagem
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Meta API    â”‚
    â”‚  (Webhook)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ 2. POST /api/webhooks/whatsapp
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                         WEBHOOK HANDLER                               â”‚
    â”‚                    /api/webhooks/whatsapp/route.ts                    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                                                                       â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
    â”‚   â”‚  STEP 1: ValidaÃ§Ã£o do Webhook                               â”‚    â”‚
    â”‚   â”‚  â€¢ Verificar assinatura X-Hub-Signature-256                 â”‚    â”‚
    â”‚   â”‚  â€¢ Validar estrutura do payload                             â”‚    â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
    â”‚                              â”‚                                        â”‚
    â”‚                              â–¼                                        â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
    â”‚   â”‚  STEP 2: IdentificaÃ§Ã£o do Thread                            â”‚    â”‚
    â”‚   â”‚  â€¢ Extrair phone number do payload                          â”‚    â”‚
    â”‚   â”‚  â€¢ Buscar thread existente OU criar nova                    â”‚    â”‚
    â”‚   â”‚  â€¢ Atualizar last_interaction_at                            â”‚    â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
    â”‚                              â”‚                                        â”‚
    â”‚                              â–¼                                        â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
    â”‚   â”‚  STEP 3: Carregar Contexto                                  â”‚    â”‚
    â”‚   â”‚  â€¢ Buscar Ãºltimas 10 mensagens da thread                    â”‚    â”‚
    â”‚   â”‚  â€¢ Buscar configuraÃ§Ã£o do agente ativo                      â”‚    â”‚
    â”‚   â”‚  â€¢ Carregar integraÃ§Ãµes disponÃ­veis                         â”‚    â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
    â”‚                              â”‚                                        â”‚
    â”‚                              â–¼                                        â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
    â”‚   â”‚  STEP 4: RAG - InjeÃ§Ã£o de Conhecimento                      â”‚    â”‚
    â”‚   â”‚  â€¢ Analisar intent da mensagem                              â”‚    â”‚
    â”‚   â”‚  â€¢ Buscar tÃ³picos relevantes em knowledge_base              â”‚    â”‚
    â”‚   â”‚  â€¢ Compor System Prompt dinÃ¢mico                            â”‚    â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
    â”‚                              â”‚                                        â”‚
    â”‚                              â–¼                                        â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
    â”‚   â”‚  STEP 5: AI Processing (Vercel AI SDK)                      â”‚    â”‚
    â”‚   â”‚  â€¢ Chamar generateText com tools                            â”‚    â”‚
    â”‚   â”‚  â€¢ Processar tool calls (se houver)                         â”‚    â”‚
    â”‚   â”‚  â€¢ Obter resposta final                                     â”‚    â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
    â”‚                              â”‚                                        â”‚
    â”‚                              â–¼                                        â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
    â”‚   â”‚  STEP 6: PersistÃªncia                                       â”‚    â”‚
    â”‚   â”‚  â€¢ Salvar mensagem do user no DB                            â”‚    â”‚
    â”‚   â”‚  â€¢ Salvar resposta do assistant no DB                       â”‚    â”‚
    â”‚   â”‚  â€¢ Registrar tool calls executadas                          â”‚    â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
    â”‚                              â”‚                                        â”‚
    â”‚                              â–¼                                        â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
    â”‚   â”‚  STEP 7: Envio de Resposta                                  â”‚    â”‚
    â”‚   â”‚  â€¢ POST para Meta Send Message API                          â”‚    â”‚
    â”‚   â”‚  â€¢ Retry com exponential backoff (se falhar)                â”‚    â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
    â”‚                                                                       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ 8. Resposta entregue
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  WhatsApp    â”‚
    â”‚  User        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 Estrutura do System Prompt DinÃ¢mico

```typescript
// /lib/ai/prompts.ts

export function buildSystemPrompt(params: {
  agent: Agent;
  knowledge: KnowledgeBase[];
  threadContext: Message[];
}) {
  return `
## IDENTIDADE
VocÃª Ã© ${params.agent.name}, um assistente virtual da empresa Casal do TrÃ¡fego.

## COMPORTAMENTO
${params.agent.systemPrompt}

## BASE DE CONHECIMENTO
Aqui estÃ£o informaÃ§Ãµes relevantes que vocÃª DEVE usar para responder:

${params.knowledge.map(k => `
### ${k.topic}
${k.content}
`).join('\n')}

## CONTEXTO DA CONVERSA
Ãšltimas interaÃ§Ãµes com este cliente:
${params.threadContext.map(m => `[${m.role}]: ${m.content}`).join('\n')}

## FERRAMENTAS DISPONÃVEIS
- schedule_meeting: Agendar reuniÃ£o no Google Calendar
- save_lead: Salvar lead na planilha do Google Sheets

## REGRAS
1. Seja profissional mas amigÃ¡vel
2. NUNCA invente informaÃ§Ãµes, use apenas a Base de Conhecimento
3. Se nÃ£o souber algo, diga que vai verificar e retornar
4. Use as ferramentas quando apropriado
`.trim();
}
```

### 6.3 DefiniÃ§Ã£o das Tools (Ferramentas)

```typescript
// /lib/ai/tools.ts

import { tool } from 'ai';
import { z } from 'zod';
import { scheduleGoogleCalendar } from '@/server/services/google-calendar.service';
import { appendToSheet } from '@/server/services/google-sheets.service';

export const agentTools = {
  schedule_meeting: tool({
    description: 'Agendar uma reuniÃ£o/call com o lead no Google Calendar',
    parameters: z.object({
      title: z.string().describe('TÃ­tulo da reuniÃ£o'),
      date: z.string().describe('Data no formato YYYY-MM-DD'),
      time: z.string().describe('HorÃ¡rio no formato HH:MM'),
      duration: z.number().describe('DuraÃ§Ã£o em minutos'),
      attendeeEmail: z.string().email().describe('Email do participante'),
      attendeeName: z.string().describe('Nome do participante'),
    }),
    execute: async (params) => {
      const result = await scheduleGoogleCalendar(params);
      return {
        success: true,
        eventId: result.id,
        meetLink: result.hangoutLink,
      };
    },
  }),

  save_lead: tool({
    description: 'Salvar informaÃ§Ãµes de um lead na planilha do Google Sheets',
    parameters: z.object({
      name: z.string().describe('Nome completo do lead'),
      phone: z.string().describe('Telefone do lead'),
      email: z.string().email().optional().describe('Email do lead'),
      interest: z.string().describe('Interesse/produto mencionado'),
      notes: z.string().optional().describe('ObservaÃ§Ãµes adicionais'),
    }),
    execute: async (params) => {
      const result = await appendToSheet({
        spreadsheetId: process.env.GOOGLE_LEADS_SHEET_ID!,
        range: 'Leads!A:E',
        values: [[
          params.name,
          params.phone,
          params.email || '-',
          params.interest,
          params.notes || '-',
          new Date().toISOString(),
        ]],
      });
      return { success: true, row: result.updatedRange };
    },
  }),
};
```

---

## 7. GestÃ£o de Estado das Conversas

### 7.1 Modelo de Estado de Thread

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CICLO DE VIDA DE UMA THREAD                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     CREATED     â”‚
                    â”‚  (Nova thread)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ Primeira mensagem recebida
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     ACTIVE      â”‚
                    â”‚ (Em conversa)   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
                             â”‚                            â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
           â”‚                 â”‚                 â”‚          â”‚
           â–¼                 â–¼                 â–¼          â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  PENDING    â”‚   â”‚  QUALIFIED  â”‚   â”‚   BOOKED    â”‚  â”‚
    â”‚(Aguardando) â”‚   â”‚  (Lead OK)  â”‚   â”‚ (Agendado)  â”‚  â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â”‚
           â”‚                 â”‚                 â”‚          â”‚
           â”‚                 â”‚                 â”‚          â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
                             â”‚                            â”‚
                             â”‚ Nova mensagem              â”‚
                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ Inatividade > 24h
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    ARCHIVED     â”‚
                    â”‚  (Arquivada)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


TRANSIÃ‡Ã•ES DE ESTADO:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ CREATED â†’ ACTIVE: AutomÃ¡tico na primeira mensagem
â€¢ ACTIVE â†’ PENDING: UsuÃ¡rio nÃ£o respondeu (timeout interno)
â€¢ ACTIVE â†’ QUALIFIED: IA identificou interesse genuÃ­no
â€¢ ACTIVE â†’ BOOKED: ReuniÃ£o agendada via tool
â€¢ * â†’ ARCHIVED: Job diÃ¡rio arquiva threads inativas
```

### 7.2 Ãndices e Performance

```sql
-- Ãndices crÃ­ticos para performance do webhook

-- Busca rÃ¡pida de thread por telefone
CREATE INDEX idx_threads_external_id ON threads(external_id);

-- OrdenaÃ§Ã£o de mensagens por thread
CREATE INDEX idx_messages_thread_time ON messages(thread_id, created_at DESC);

-- Busca de agentes ativos
CREATE INDEX idx_agents_active ON agents(is_active) WHERE is_active = true;

-- Busca de conhecimento por agente e tÃ³pico
CREATE INDEX idx_knowledge_agent_topic ON knowledge_base(agent_id, topic);
```

---

## 8. IntegraÃ§Ãµes Externas

### 8.1 Mapa de IntegraÃ§Ãµes

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           INTEGRAÃ‡Ã•ES EXTERNAS                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                          META WHATSAPP API                         â”‚    â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚   â”‚  PropÃ³sito: Receber e enviar mensagens de WhatsApp                â”‚    â”‚
â”‚   â”‚                                                                    â”‚    â”‚
â”‚   â”‚  Credenciais NecessÃ¡rias:                                         â”‚    â”‚
â”‚   â”‚  â€¢ WHATSAPP_TOKEN (Bearer Token)                                  â”‚    â”‚
â”‚   â”‚  â€¢ WHATSAPP_PHONE_ID (ID do nÃºmero de telefone)                   â”‚    â”‚
â”‚   â”‚  â€¢ WHATSAPP_VERIFY_TOKEN (VerificaÃ§Ã£o do Webhook)                 â”‚    â”‚
â”‚   â”‚  â€¢ WHATSAPP_APP_SECRET (ValidaÃ§Ã£o de assinatura)                  â”‚    â”‚
â”‚   â”‚                                                                    â”‚    â”‚
â”‚   â”‚  Endpoints Utilizados:                                            â”‚    â”‚
â”‚   â”‚  â€¢ POST /v18.0/{phone_id}/messages (Enviar)                       â”‚    â”‚
â”‚   â”‚  â€¢ Webhook: POST /api/webhooks/whatsapp (Receber)                 â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                         GOOGLE CALENDAR API                        â”‚    â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚   â”‚  PropÃ³sito: Criar eventos/reuniÃµes automaticamente                â”‚    â”‚
â”‚   â”‚                                                                    â”‚    â”‚
â”‚   â”‚  Fluxo de AutenticaÃ§Ã£o: OAuth 2.0                                 â”‚    â”‚
â”‚   â”‚  1. UsuÃ¡rio conecta conta no /dashboard/integrations              â”‚    â”‚
â”‚   â”‚  2. Sistema obtÃ©m refresh_token                                   â”‚    â”‚
â”‚   â”‚  3. Token armazenado criptografado em `integrations`              â”‚    â”‚
â”‚   â”‚                                                                    â”‚    â”‚
â”‚   â”‚  Scopes NecessÃ¡rios:                                              â”‚    â”‚
â”‚   â”‚  â€¢ https://www.googleapis.com/auth/calendar.events                â”‚    â”‚
â”‚   â”‚                                                                    â”‚    â”‚
â”‚   â”‚  Endpoints Utilizados:                                            â”‚    â”‚
â”‚   â”‚  â€¢ POST /calendar/v3/calendars/primary/events (Criar evento)      â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                         GOOGLE SHEETS API                          â”‚    â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚   â”‚  PropÃ³sito: Registrar leads em planilha                           â”‚    â”‚
â”‚   â”‚                                                                    â”‚    â”‚
â”‚   â”‚  Fluxo: Mesmo OAuth do Calendar (scope adicional)                 â”‚    â”‚
â”‚   â”‚                                                                    â”‚    â”‚
â”‚   â”‚  Scopes Adicionais:                                               â”‚    â”‚
â”‚   â”‚  â€¢ https://www.googleapis.com/auth/spreadsheets                   â”‚    â”‚
â”‚   â”‚                                                                    â”‚    â”‚
â”‚   â”‚  Endpoints Utilizados:                                            â”‚    â”‚
â”‚   â”‚  â€¢ POST /v4/spreadsheets/{id}/values/{range}:append               â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                           OPENAI API                               â”‚    â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚   â”‚  PropÃ³sito: Processamento de linguagem natural                    â”‚    â”‚
â”‚   â”‚                                                                    â”‚    â”‚
â”‚   â”‚  Via: Vercel AI SDK (abstraÃ§Ã£o)                                   â”‚    â”‚
â”‚   â”‚                                                                    â”‚    â”‚
â”‚   â”‚  Modelos Suportados:                                              â”‚    â”‚
â”‚   â”‚  â€¢ gpt-4o (PadrÃ£o - melhor qualidade)                             â”‚    â”‚
â”‚   â”‚  â€¢ gpt-4o-mini (Economia - alto volume)                           â”‚    â”‚
â”‚   â”‚  â€¢ gpt-4-turbo (Contexto longo)                                   â”‚    â”‚
â”‚   â”‚                                                                    â”‚    â”‚
â”‚   â”‚  ConfiguraÃ§Ãµes por Agente (model_config):                         â”‚    â”‚
â”‚   â”‚  â€¢ model: string                                                  â”‚    â”‚
â”‚   â”‚  â€¢ temperature: 0-1                                               â”‚    â”‚
â”‚   â”‚  â€¢ maxTokens: number                                              â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 SeguranÃ§a de Credenciais

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ARMAZENAMENTO DE CREDENCIAIS                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   VARIÃVEIS DE AMBIENTE (NÃ£o mutÃ¡veis):                                    â”‚
â”‚   â”œâ”€â”€ OPENAI_API_KEY                                                       â”‚
â”‚   â”œâ”€â”€ WHATSAPP_TOKEN                                                       â”‚
â”‚   â”œâ”€â”€ WHATSAPP_PHONE_ID                                                    â”‚
â”‚   â”œâ”€â”€ WHATSAPP_VERIFY_TOKEN                                                â”‚
â”‚   â”œâ”€â”€ WHATSAPP_APP_SECRET                                                  â”‚
â”‚   â””â”€â”€ ENCRYPTION_KEY (Para criptografar integrations.credentials)          â”‚
â”‚                                                                             â”‚
â”‚   BANCO DE DADOS (MutÃ¡veis - por usuÃ¡rio):                                 â”‚
â”‚   â””â”€â”€ integrations.credentials (JSON criptografado com AES-256-GCM)        â”‚
â”‚       â”œâ”€â”€ google.access_token                                              â”‚
â”‚       â”œâ”€â”€ google.refresh_token                                             â”‚
â”‚       â””â”€â”€ google.token_expiry                                              â”‚
â”‚                                                                             â”‚
â”‚   FLUXO DE CRIPTOGRAFIA:                                                   â”‚
â”‚   1. UsuÃ¡rio conecta conta Google                                          â”‚
â”‚   2. OAuth retorna tokens                                                  â”‚
â”‚   3. Tokens criptografados com ENCRYPTION_KEY                              â”‚
â”‚   4. JSON criptografado salvo em integrations.credentials                  â”‚
â”‚   5. Na leitura: decripta, valida expiraÃ§Ã£o, renova se necessÃ¡rio          â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 9. SeguranÃ§a e AutenticaÃ§Ã£o

### 9.1 Camadas de SeguranÃ§a

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          CAMADAS DE SEGURANÃ‡A                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   LAYER 1: AutenticaÃ§Ã£o de UsuÃ¡rio (Dashboard)                             â”‚
â”‚   â”œâ”€â”€ NextAuth.js v5                                                       â”‚
â”‚   â”œâ”€â”€ Providers: Credentials (Email/Password) ou OAuth (Google)            â”‚
â”‚   â”œâ”€â”€ SessÃ£o: JWT com rotaÃ§Ã£o                                              â”‚
â”‚   â””â”€â”€ Middleware: Protege todas as rotas /dashboard/*                      â”‚
â”‚                                                                             â”‚
â”‚   LAYER 2: ValidaÃ§Ã£o de Webhook                                            â”‚
â”‚   â”œâ”€â”€ VerificaÃ§Ã£o de X-Hub-Signature-256                                   â”‚
â”‚   â”œâ”€â”€ ValidaÃ§Ã£o de payload com Zod                                         â”‚
â”‚   â””â”€â”€ Rate limiting por IP (10 req/s)                                      â”‚
â”‚                                                                             â”‚
â”‚   LAYER 3: AutorizaÃ§Ã£o de Recursos                                         â”‚
â”‚   â”œâ”€â”€ UsuÃ¡rio sÃ³ acessa seus prÃ³prios agentes/threads                      â”‚
â”‚   â”œâ”€â”€ VerificaÃ§Ã£o de ownership em todas as queries                         â”‚
â”‚   â””â”€â”€ Server Actions validam permissÃµes                                    â”‚
â”‚                                                                             â”‚
â”‚   LAYER 4: ProteÃ§Ã£o de Dados SensÃ­veis                                     â”‚
â”‚   â”œâ”€â”€ Credenciais criptografadas no DB                                     â”‚
â”‚   â”œâ”€â”€ Logs nÃ£o contÃªm tokens/secrets                                       â”‚
â”‚   â””â”€â”€ Messages podem ser purged apÃ³s perÃ­odo                               â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.2 Middleware de ProteÃ§Ã£o

```typescript
// /middleware.ts

import { auth } from '@/lib/auth';
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export async function middleware(request: NextRequest) {
  const { pathname } = request.nextUrl;
  
  // Rotas pÃºblicas
  if (
    pathname === '/' ||
    pathname.startsWith('/api/webhooks') ||
    pathname.startsWith('/api/auth')
  ) {
    return NextResponse.next();
  }
  
  // Rotas protegidas
  if (pathname.startsWith('/dashboard')) {
    const session = await auth();
    
    if (!session?.user) {
      return NextResponse.redirect(new URL('/login', request.url));
    }
  }
  
  return NextResponse.next();
}

export const config = {
  matcher: ['/((?!_next/static|_next/image|favicon.ico).*)'],
};
```

---

## 10. DecisÃµes de Design

### 10.1 ADRs (Architecture Decision Records)

#### ADR-001: Server Actions vs API Routes para MutaÃ§Ãµes

**Contexto:** Precisamos decidir como o frontend vai comunicar mutaÃ§Ãµes para o backend.

**DecisÃ£o:** Usar **Server Actions** para todas as mutaÃ§Ãµes do dashboard.

**Justificativa:**
- Menos boilerplate que API Routes
- Type safety end-to-end automÃ¡tico
- IntegraÃ§Ã£o nativa com forms do React
- Melhor DX com useFormState/useOptimisticAction

**ConsequÃªncias:**
- âœ… CÃ³digo mais limpo
- âœ… Menos arquivos para manter
- âš ï¸ Requer entendimento de 'use server'

---

#### ADR-002: Drizzle ORM vs Prisma

**Contexto:** Escolher ORM para acesso ao banco de dados.

**DecisÃ£o:** Usar **Drizzle ORM**.

**Justificativa:**
- Performance superior (SQL-like queries)
- Bundle size menor (melhor para serverless)
- Melhor DX para queries complexas
- Migrations mais previsÃ­veis

**ConsequÃªncias:**
- âœ… Queries mais performÃ¡ticas
- âœ… Menor cold start em serverless
- âš ï¸ Comunidade menor que Prisma

---

#### ADR-003: Vercel AI SDK vs LangChain

**Contexto:** Escolher framework para orquestraÃ§Ã£o de IA.

**DecisÃ£o:** Usar **Vercel AI SDK**.

**Justificativa:**
- IntegraÃ§Ã£o nativa com Next.js
- Tool calling simplificado
- Streaming de respostas otimizado
- Menos abstraÃ§Ã£o = mais controle

**ConsequÃªncias:**
- âœ… Setup mais simples
- âœ… Menos dependÃªncias
- âš ï¸ Menos features de orquestraÃ§Ã£o complexa

---

#### ADR-004: Neon vs Supabase vs PlanetScale

**Contexto:** Escolher provider de banco de dados serverless.

**DecisÃ£o:** Usar **Neon**.

**Justificativa:**
- Postgres nativo (sem vendor lock-in)
- Branching de bancos para staging
- Pricing competitivo
- Cold start extremamente rÃ¡pido

**ConsequÃªncias:**
- âœ… DX familiar para quem conhece Postgres
- âœ… Features avanÃ§adas (branching, compute scaling)
- âš ï¸ Menos integrado que Supabase (sem auth built-in)

---

### 10.2 Trade-offs Conhecidos

| DecisÃ£o | Trade-off | MitigaÃ§Ã£o |
|---------|-----------|-----------|
| RSC por padrÃ£o | Complexidade de hidrataÃ§Ã£o | DocumentaÃ§Ã£o clara sobre quando usar 'use client' |
| Server Actions | NÃ£o funciona offline | NÃ£o Ã© requisito para este sistema |
| Neon Serverless | Cold starts em baixo uso | Provisioned compute em produÃ§Ã£o |
| Vercel AI SDK | Menos flexÃ­vel que LangChain | Suficiente para os use cases atuais |

---

## ApÃªndice: GlossÃ¡rio

| Termo | DefiniÃ§Ã£o |
|-------|-----------|
| **Thread** | Uma conversa com um contato especÃ­fico (identificado por telefone) |
| **Agent** | ConfiguraÃ§Ã£o de um assistente virtual (prompt, modelo, ferramentas) |
| **Knowledge Base** | Conjunto de tÃ³picos com conteÃºdo que alimenta o agente |
| **Tool** | FunÃ§Ã£o que a IA pode chamar para executar aÃ§Ãµes externas |
| **Webhook** | Endpoint que recebe notificaÃ§Ãµes de serviÃ§os externos |
| **RSC** | React Server Components - componentes que renderizam no servidor |
| **Server Action** | FunÃ§Ã£o do servidor que pode ser chamada diretamente do cliente |

---

> ğŸ“‹ **PrÃ³ximos Passos:**
> 1. âœ… Criar ARCHITECTURE.md (Este documento)
> 2. â³ Criar schema.ts (Drizzle Schema)
> 3. â³ Configurar layout.tsx (Sidebar + ConteÃºdo)
> 4. â³ Implementar hook de conexÃ£o com IA
