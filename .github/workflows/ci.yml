name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - '**/*.md'
      - '**/*.mdx'
      - '.github/**/*.md'
  pull_request:
    branches: [main, develop]

defaults:
  timeout-minutes: 15

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    env:
      # Core environment
      NODE_ENV: test
      NODE_OPTIONS: '--max-old-space-size=4096'
      
      # Database configuration with fallback to SQLite for testing
      DATABASE_URL: ${{ secrets.TEST_DATABASE_URL || 'file:./test.db' }}
      
      # AI Provider API Keys with empty defaults
      # These are required in production but can be empty for basic testing
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || 'test-key' }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY || 'test-key' }}
      GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY || 'test-key' }}
      
      # Test-specific overrides
      TEST_TIMEOUT: 30000  # 30 seconds
      CI: true

    strategy:
      matrix:
        node-version: [20.x]
        os: [ubuntu-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Verify Node.js and npm versions
        run: |
          node --version
          npm --version

      - name: Run type checking
        run: npx tsc --noEmit

      - name: Lint code
        run: npm run lint

      - name: Run unit tests
        run: npm test -- --coverage

      - name: Upload test coverage
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./coverage/lcov.info
          fail_ci_if_error: false

      - name: Build application
        run: npm run build

      - name: Run security audit
        run: npm audit --production

  # Add deployment jobs here once testing is stable
  # deploy:
  #   needs: test
  #   if: github.ref == 'refs/heads/main'
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/setup-node@v4
  #       with:
  #         node-version: '20'
  #     - run: npm ci --production
  #     - run: npm run build
  #     # Add deployment steps here

  # Add scheduled security updates
  dependabot:
    name: Dependabot auto-approve
    runs-on: ubuntu-latest
    if: ${{ github.actor == 'dependabot[bot]' }}
    steps:
      - name: Dependabot metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Enable auto-merge for Dependabot PRs
        if: ${{ github.actor == 'dependabot[bot]' }}
        run: gh pr merge --auto --merge "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
